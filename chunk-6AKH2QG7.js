import{Ea as p,Fa as G,Ha as S,Ia as R,Ja as d,Ka as q,La as y,Ma as h,Na as g,Pa as k,Qa as v,Ra as C,Sa as f,Ta as P,Ua as I,Va as m,a as w,c as l,d as T,g as A,k as U,o as E,xa as M}from"./chunk-USMQHQW2.js";var F=class b{firestore=E(G);auth=E(M);createTournament(){return l(this,null,function*(){let e=this.auth.currentUser;if(!e)throw new Error("Not authenticated");let t=y(this.firestore,"users",e.uid),s=yield h(t),a=s.exists()?s.data().nickname:e.email||"",r=d(this.firestore,"tournaments"),i={player1Id:e.uid,player1Email:e.email||"",player1Nickname:a,status:"waiting",currentRound:1,player1Score:0,player2Score:0,rounds:this.initializeRounds(),createdAt:p.now(),updatedAt:p.now(),gameMode:"tournament"};return(yield R(r,i)).id})}createComputerTournament(){return l(this,null,function*(){let e=this.auth.currentUser;if(!e)throw new Error("Not authenticated");let t=y(this.firestore,"users",e.uid),s=yield h(t),a=s.exists()?s.data().nickname:e.email,r=d(this.firestore,"tournaments"),i={player1Id:e.uid,player1Email:e.email||"",player1Nickname:a,player2Id:"COMPUTER",player2Email:"\u{1F916} Computer",player2Nickname:"\u{1F916} Computer",isVsComputer:!0,status:"in-progress",currentRound:1,player1Score:0,player2Score:0,rounds:this.initializeRounds(),createdAt:p.now(),updatedAt:p.now(),gameMode:"tournament"};return(yield R(r,i)).id})}createCasualComputerGame(){return l(this,null,function*(){let e=this.auth.currentUser;if(!e)throw new Error("Not authenticated");let t=y(this.firestore,"users",e.uid),s=yield h(t),a=s.exists()?s.data().nickname:e.email,r=d(this.firestore,"tournaments"),i={player1Id:e.uid,player1Email:e.email||"",player1Nickname:a,player2Id:"COMPUTER",player2Email:"\u{1F916} Computer",player2Nickname:"\u{1F916} Computer",isVsComputer:!0,gameMode:"casual",status:"in-progress",currentRound:1,player1Score:0,player2Score:0,rounds:[{roundNumber:1,player1Choice:null,player2Choice:null,winner:null,completed:!1}],createdAt:p.now(),updatedAt:p.now()};return(yield R(r,i)).id})}createCasualGame(){return l(this,null,function*(){let e=this.auth.currentUser;if(!e)throw new Error("Not authenticated");let t=y(this.firestore,"users",e.uid),s=yield h(t),a=s.exists()?s.data().nickname:e.email,r=d(this.firestore,"tournaments"),i={player1Id:e.uid,player1Email:e.email||"",player1Nickname:a,player2Id:null,player2Email:null,player2Nickname:null,isVsComputer:!1,gameMode:"casual",status:"waiting",currentRound:1,player1Score:0,player2Score:0,rounds:[{roundNumber:1,player1Choice:null,player2Choice:null,winner:null,completed:!1}],createdAt:p.now(),updatedAt:p.now()};return(yield R(r,i)).id})}getInProgressCasualGames(e){let t=f(d(this.firestore,"tournaments"),m("gameMode","==","casual"),m("status","==","in-progress"),C("updatedAt","desc"));return S(t,{idField:"id"}).pipe(A(s=>s.filter(a=>a.player1Id===e||a.player2Id===e)))}hasActiveGameWith(e){return l(this,null,function*(){let t=this.auth.currentUser;if(!t)return null;let s=f(d(this.firestore,"tournaments"),m("status","in",["waiting","in-progress"]),C("updatedAt","desc")),r=(yield g(s)).docs.map(i=>w({id:i.id},i.data())).filter(i=>i.player1Id===t.uid&&i.player2Id===e||i.player2Id===t.uid&&i.player1Id===e);return r.length>0?r[0].id:null})}joinTournament(e){return l(this,null,function*(){let t=this.auth.currentUser;if(!t)throw new Error("Not authenticated");let s=y(this.firestore,"tournaments",e),a=yield h(s);if(!a.exists())throw new Error("Tournament not found");let r=a.data(),i=yield this.hasActiveGameWith(r.player1Id);if(i&&i!==e)throw new Error("You already have an active game with this player");let c=y(this.firestore,"users",t.uid),o=yield h(c),n=o.exists()?o.data().nickname:t.email||"";yield I(s,{player2Id:t.uid,player2Email:t.email||"",player2Nickname:n,status:"in-progress",updatedAt:p.now()})})}searchUsers(e){return l(this,null,function*(){let t=d(this.firestore,"users"),s=f(t,m("nickname",">=",e),m("nickname","<=",e+"\uF8FF"),k(10));return(yield g(s)).docs.map(r=>({uid:r.id,nickname:r.data().nickname}))})}makeChoice(e,t){return l(this,null,function*(){let s=y(this.firestore,"tournaments",e),a=yield h(s);if(!a.exists())throw new Error("Tournament not found");let r=a.data(),i=this.auth.currentUser;if(!i)throw new Error("Not authenticated");let c=i.uid===r.player1Id,o=r.rounds[r.currentRound-1];if(c&&o.player1Choice){console.log("Player 1 already made choice");return}if(!c&&o.player2Choice){console.log("Player 2 already made choice");return}if(c?o.player1Choice=t:o.player2Choice=t,r.isVsComputer&&c&&!o.player2Choice){let n=["rock","paper","scissors"];o.player2Choice=n[Math.floor(Math.random()*n.length)]}if(o.player1Choice&&o.player2Choice){let n=this.determineWinner(o.player1Choice,o.player2Choice);o.winner=n==="player1"?r.player1Id:n==="player2"?r.player2Id||"COMPUTER":null,o.completed=!0,n==="player1"&&r.player1Score++,n==="player2"&&r.player2Score++,r.gameMode==="casual"?(r.currentRound++,r.rounds.push({roundNumber:r.currentRound,player1Choice:null,player2Choice:null,winner:null,completed:!1})):r.currentRound<5?r.currentRound++:(r.status="completed",yield this.updatePlayerStats(r))}r.updatedAt=p.now(),yield I(s,r)})}determineWinner(e,t){return e===t?null:e==="rock"&&t==="scissors"||e==="paper"&&t==="rock"||e==="scissors"&&t==="paper"?"player1":"player2"}updatePlayerStats(e){return l(this,null,function*(){return Promise.resolve()})}getComputerChoice(){return["rock","paper","scissors"][Math.floor(Math.random()*3)]}determineRoundWinner(e,t,s,a){return e===t?null:e==="rock"&&t==="scissors"||e==="paper"&&t==="rock"||e==="scissors"&&t==="paper"?s:a}initializeRounds(){return Array.from({length:5},(e,t)=>({roundNumber:t+1,player1Choice:null,player2Choice:null,winner:null,completed:!1}))}getTournament(e){return new T(t=>{let s=y(this.firestore,"tournaments",e),a=v(s,r=>{r.exists()?t.next(w({id:r.id},r.data())):t.next(null)},r=>{t.error(r)});return()=>a()})}getAvailableTournaments(){return new T(e=>{let t=d(this.firestore,"tournaments"),s=f(t,m("status","==","waiting"),k(20)),a=v(s,r=>{let i=r.docs.map(c=>w({id:c.id},c.data()));e.next(i)},r=>{e.error(r)});return()=>a()})}deleteTournament(e){return l(this,null,function*(){let t=y(this.firestore,"tournaments",e);yield q(t)})}getUserGameHistory(e){return l(this,null,function*(){let t=d(this.firestore,"tournaments"),s=f(t,m("status","==","completed"),k(50));return(yield g(s)).docs.map(i=>w({id:i.id},i.data())).filter(i=>i.player1Id===e||i.player2Id===e).sort((i,c)=>c.updatedAt?.toMillis()-i.updatedAt?.toMillis())})}getUserStats(e,t){let s=0,a=0,r=0,i=0,c=0;return t.forEach(o=>{let n=o.player1Id===e,u=n?o.player1Score:o.player2Score,N=n?o.player2Score:o.player1Score;u>N?s++:u<N?a++:r++,i+=u,c+=N}),{totalGames:t.length,wins:s,losses:a,draws:r,winRate:t.length>0?(s/t.length*100).toFixed(1):"0.0",totalRoundsWon:i,totalRoundsLost:c}}getLeaderboardData(e){return l(this,null,function*(){let t=d(this.firestore,"tournaments"),s=new Date;switch(e){case"day":s.setDate(s.getDate()-1);break;case"week":s.setDate(s.getDate()-7);break;case"month":s.setMonth(s.getMonth()-1);break;case"year":s.setFullYear(s.getFullYear()-1);break;case"all":s=new Date(0);break}let a=f(t,m("status","==","completed"),k(500)),c=(yield g(a)).docs.map(n=>w({id:n.id},n.data())).filter(n=>n.updatedAt&&n.updatedAt.toDate()>=s),o=new Map;return c.forEach(n=>{if(n.player1Id&&!n.isVsComputer){let u=o.get(n.player1Id)||{userId:n.player1Id,email:n.player1Email,wins:0,losses:0,draws:0,totalGames:0,roundsWon:0,roundsLost:0,winRate:0};u.totalGames++,u.roundsWon+=n.player1Score,u.roundsLost+=n.player2Score,n.player1Score>n.player2Score?u.wins++:n.player1Score<n.player2Score?u.losses++:u.draws++,u.winRate=u.wins/u.totalGames*100,o.set(n.player1Id,u)}if(n.player2Id&&n.player2Id!=="COMPUTER"){let u=o.get(n.player2Id)||{userId:n.player2Id,email:n.player2Email||"Unknown",wins:0,losses:0,draws:0,totalGames:0,roundsWon:0,roundsLost:0,winRate:0};u.totalGames++,u.roundsWon+=n.player2Score,u.roundsLost+=n.player1Score,n.player2Score>n.player1Score?u.wins++:n.player2Score<n.player1Score?u.losses++:u.draws++,u.winRate=u.wins/u.totalGames*100,o.set(n.player2Id,u)}}),Array.from(o.values()).sort((n,u)=>u.wins!==n.wins?u.wins-n.wins:u.winRate-n.winRate).slice(0,10)})}addFriend(e,t,s){return l(this,null,function*(){if(yield this.getFriend(e,t))throw new Error("Already friends");let r=d(this.firestore,"friends");yield R(r,{userId:e,friendId:t,friendEmail:"",friendNickname:s,addedAt:p.now()})})}removeFriend(e){return l(this,null,function*(){let t=this.auth.currentUser;if(!t)throw new Error("Not authenticated");let s=d(this.firestore,"friends"),a=f(s,m("userId","==",t.uid),m("friendId","==",e));(yield g(a)).forEach(i=>l(this,null,function*(){yield q(i.ref)}))})}getFriends(e){return l(this,null,function*(){let t=d(this.firestore,"friends"),s=f(t,m("userId","==",e),C("addedAt","desc"));return(yield g(s)).docs.map(r=>w({id:r.id},r.data()))})}getFriend(e,t){return l(this,null,function*(){let s=d(this.firestore,"friends"),a=f(s,m("userId","==",e),m("friendId","==",t)),r=yield g(a);return r.empty?null:w({id:r.docs[0].id},r.docs[0].data())})}isFriend(e){return l(this,null,function*(){let t=this.auth.currentUser;return t?(yield this.getFriend(t.uid,e))!==null:!1})}sendGameRequest(e,t,s){return l(this,null,function*(){let a=this.auth.currentUser?.uid;if(!a)throw new Error("Not authenticated");let r=this.auth.currentUser?.email||"",i=yield this.getUserNickname(a),c=y(d(this.firestore,"gameRequests"));yield P(c,{id:c.id,fromUserId:a,fromEmail:r,fromNickname:i||r,toUserId:e,status:"pending",createdAt:p.now()})})}getGameRequests(e){let t=f(d(this.firestore,"gameRequests"),m("toUserId","==",e),m("status","==","pending"),C("createdAt","desc"));return S(t,{idField:"id"})}getSentGameRequests(e){let t=f(d(this.firestore,"gameRequests"),m("fromUserId","==",e),m("status","in",["pending","accepted"]),C("createdAt","desc"));return S(t,{idField:"id"})}acceptGameRequest(e){return l(this,null,function*(){let t=y(this.firestore,"gameRequests",e),s=yield h(t);if(!s.exists())throw new Error("Request not found");let a=s.data(),r=yield this.createTournamentForRequest(a.fromUserId,a.fromEmail,a.fromNickname,a.toUserId);return yield I(t,{status:"accepted",tournamentId:r}),r})}declineGameRequest(e){return l(this,null,function*(){let t=y(this.firestore,"gameRequests",e);yield I(t,{status:"declined"})})}createTournamentForRequest(e,t,s,a){return l(this,null,function*(){let r=this.auth.currentUser?.email||"",i=yield this.getUserNickname(a),c=y(d(this.firestore,"tournaments")),o={id:c.id,player1Id:e,player1Email:t,player1Nickname:s||t,player2Id:a,player2Email:r,player2Nickname:i||r,player1Score:0,player2Score:0,currentRound:1,status:"in-progress",rounds:this.initializeRounds(),createdAt:p.now(),updatedAt:p.now(),isVsComputer:!1,gameMode:"tournament"};return yield P(c,o),c.id})}getUserNickname(e){return l(this,null,function*(){let t=y(this.firestore,"users",e),s=yield h(t);return s.exists()&&s.data().nickname||""})}getChatMessages(e){let t=f(d(this.firestore,"chatMessages"),m("tournamentId","==",e),C("timestamp","asc"),k(50));return S(t,{idField:"id"})}sendChatMessage(e,t){return l(this,null,function*(){let s=this.auth.currentUser;if(!s)throw new Error("Not authenticated");let a=yield this.getUserNickname(s.uid),r=d(this.firestore,"chatMessages");yield R(r,{tournamentId:e,userId:s.uid,userNickname:a||s.email||"Player",message:t.trim(),timestamp:p.now()})})}clearChatMessages(e){return l(this,null,function*(){let t=f(d(this.firestore,"chatMessages"),m("tournamentId","==",e)),a=(yield g(t)).docs.map(r=>q(r.ref));yield Promise.all(a)})}static \u0275fac=function(t){return new(t||b)};static \u0275prov=U({token:b,factory:b.\u0275fac,providedIn:"root"})};export{F as a};
