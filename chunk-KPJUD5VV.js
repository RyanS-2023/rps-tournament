import{a as p,b as v,d as x,e as m,f as P,g as w,h as G,i as T,k as f,l as A,m as q,n as h,o as g,p as S}from"./chunk-EXYLIBEK.js";import{Ua as k,a as y,c as u,d as I,k as E,n as C}from"./chunk-UKGZAEMS.js";var U=class R{firestore=C(v);auth=C(k);createTournament(){return u(this,null,function*(){let a=this.auth.currentUser;if(!a)throw new Error("Not authenticated");let r=m(this.firestore,"tournaments"),s={player1Id:a.uid,player1Email:a.email||"",status:"waiting",currentRound:1,player1Score:0,player2Score:0,rounds:this.initializeRounds(),createdAt:p.now(),updatedAt:p.now()};return(yield x(r,s)).id})}joinTournament(a){return u(this,null,function*(){let r=this.auth.currentUser;if(!r)throw new Error("Not authenticated");let s=w(this.firestore,"tournaments",a);yield g(s,{player2Id:r.uid,player2Email:r.email,status:"in-progress",updatedAt:p.now()})})}makeChoice(a,r){return u(this,null,function*(){let s=this.auth.currentUser;if(!s)throw new Error("Not authenticated");let c=w(this.firestore,"tournaments",a),i=yield G(c);if(!i.exists())throw new Error("Tournament not found");let n=i.data(),l=n.currentRound-1,o=[...n.rounds];if(s.uid===n.player1Id?o[l].player1Choice=r:o[l].player2Choice=r,o[l].player1Choice&&o[l].player2Choice){let t=this.determineRoundWinner(o[l].player1Choice,o[l].player2Choice,n.player1Id,n.player2Id);o[l].winner=t,o[l].completed=!0;let d=n.player1Score,D=n.player2Score;t===n.player1Id?d++:t===n.player2Id&&D++;let b={rounds:o,player1Score:d,player2Score:D,updatedAt:p.now()};n.currentRound>=5?b.status="completed":o[l].completed&&(b.currentRound=n.currentRound+1),yield g(c,b)}else yield g(c,{rounds:o,updatedAt:p.now()})})}determineRoundWinner(a,r,s,c){return a===r?null:a==="rock"&&r==="scissors"||a==="paper"&&r==="rock"||a==="scissors"&&r==="paper"?s:c}initializeRounds(){return Array.from({length:5},(a,r)=>({roundNumber:r+1,player1Choice:null,player2Choice:null,winner:null,completed:!1}))}getTournament(a){return new I(r=>{let s=w(this.firestore,"tournaments",a),c=A(s,i=>{i.exists()?r.next(y({id:i.id},i.data())):r.next(null)},i=>{r.error(i)});return()=>c()})}getAvailableTournaments(){return new I(a=>{let r=m(this.firestore,"tournaments"),s=h(r,S("status","==","waiting"),f(20)),c=A(s,i=>{let n=i.docs.map(l=>y({id:l.id},l.data()));a.next(n)},i=>{a.error(i)});return()=>c()})}deleteTournament(a){return u(this,null,function*(){let r=w(this.firestore,"tournaments",a);yield P(r)})}getUserGameHistory(a){return u(this,null,function*(){let r=m(this.firestore,"tournaments"),s=h(r,S("status","==","completed"),q("updatedAt","desc"),f(50));return(yield T(s)).docs.map(n=>y({id:n.id},n.data())).filter(n=>n.player1Id===a||n.player2Id===a)})}getUserStats(a,r){let s=0,c=0,i=0,n=0,l=0;return r.forEach(o=>{let e=o.player1Id===a,t=e?o.player1Score:o.player2Score,d=e?o.player2Score:o.player1Score;t>d?s++:t<d?c++:i++,n+=t,l+=d}),{totalGames:r.length,wins:s,losses:c,draws:i,winRate:r.length>0?(s/r.length*100).toFixed(1):"0.0",totalRoundsWon:n,totalRoundsLost:l}}getLeaderboardData(a){return u(this,null,function*(){let r=m(this.firestore,"tournaments"),s=new Date;switch(a){case"day":s.setDate(s.getDate()-1);break;case"week":s.setDate(s.getDate()-7);break;case"month":s.setMonth(s.getMonth()-1);break;case"year":s.setFullYear(s.getFullYear()-1);break;case"all":s=new Date(0);break}let c=h(r,S("status","==","completed"),f(500)),l=(yield T(c)).docs.map(e=>y({id:e.id},e.data())).filter(e=>e.updatedAt&&e.updatedAt.toDate()>=s),o=new Map;return l.forEach(e=>{if(e.player1Id&&e.player2Id!=="COMPUTER"){let t=o.get(e.player1Id)||{userId:e.player1Id,email:e.player1Email,wins:0,losses:0,draws:0,totalGames:0,roundsWon:0,roundsLost:0,winRate:0};t.totalGames++,t.roundsWon+=e.player1Score,t.roundsLost+=e.player2Score,e.player1Score>e.player2Score?t.wins++:e.player1Score<e.player2Score?t.losses++:t.draws++,t.winRate=t.wins/t.totalGames*100,o.set(e.player1Id,t)}if(e.player2Id&&e.player2Id!=="COMPUTER"){let t=o.get(e.player2Id)||{userId:e.player2Id,email:e.player2Email||"Unknown",wins:0,losses:0,draws:0,totalGames:0,roundsWon:0,roundsLost:0,winRate:0};t.totalGames++,t.roundsWon+=e.player2Score,t.roundsLost+=e.player1Score,e.player2Score>e.player1Score?t.wins++:e.player2Score<e.player1Score?t.losses++:t.draws++,t.winRate=t.wins/t.totalGames*100,o.set(e.player2Id,t)}}),Array.from(o.values()).sort((e,t)=>t.wins!==e.wins?t.wins-e.wins:t.winRate-e.winRate).slice(0,10)})}static \u0275fac=function(r){return new(r||R)};static \u0275prov=E({token:R,factory:R.\u0275fac,providedIn:"root"})};export{U as a};
